events {
  worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    map $args $auth_header {
      # dummy header for email@example.com
      default "eyJ0eXAiOiJKV1QiLCJraWQiOiIxMjM0OTQ3YS01OWQzLTQ2N2MtODgwYy1mMDA1YzY5NDFmZmciLCJhbGciOiJIUzI1NiIsImlzcyI6Imh0dHBzOi8va2V5Y2xvYWstZGV2LmFpLmNhYmluZXRvZmZpY2UuZ292LnVrL3JlYWxtcy9pX2FpIiwiY2xpZW50IjoiMzIzamQwbmluZG92YTNzcXU1bG42NjU0MzIiLCJzaWduZXIiOiJhcm46YXdzOmVsYXN0aWNsb2FkYmFsYW5jaW5nOmV1LXdlc3QtMjphY2M6bG9hZGJhbGFuY2VyL2FwcC9hbGIvOTlqZDI1MGEwM2U3NWRlcyIsImV4cCI6MTcyNzI2MjM5OX0.eyJzdWIiOiI5MDQyOTIzNC00MDMxLTcwNzctYjliYS02MGQxYWYxMjEyNDUiLCJlbWFpbCI6ImVtYWlsQGV4YW1wbGUuY29tIiwiYXVkIjoiYWNjb3VudCIsImV4cCI6MTcyNzI2MjM5OSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbImNhZGR5IiwiY2FkZHlfbW9kZWwiXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbInZpZXctcHJvZmlsZSJdfX19.-ztawPlXS7XrJKN04TQSKBVNAugb1HF-UyUPSHWk8_A"; # pragma: allowlist secret
    }

    # model
    server {
        listen 80;
        server_name localhost;

        location / {
            proxy_pass http://model:8080;
            proxy_set_header Host $host;
            proxy_set_header x-amzn-oidc-accesstoken $auth_header;
        }
    }

    # client
    server {
        listen 81;
        server_name localhost;

        location / {
            proxy_pass http://client:8081;
            proxy_set_header Host $host;
            proxy_set_header x-amzn-oidc-accesstoken $auth_header;
        }
    }

    # frontend
    server {
        listen 82;
        server_name localhost;

        location / {
            proxy_pass http://frontend:4322;
            proxy_set_header Host $host;
            proxy_set_header x-amzn-oidc-accesstoken $auth_header;
        }
    }
}
